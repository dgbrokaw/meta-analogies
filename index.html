<!doctype html>

<title>Meta-analogies (rocks)</title>
<script src='d3.min.js'></script>
<script src='settings.js'></script>
<script src='rock.js'></script>
<script src='support-category.js'></script>
<script src='data.js'></script>

<style>
.noselect {
	-webkit-user-select:none;
}
</style>

<body>
</body>

<script>

// TODO:
// have selectedRock
// around selectedRock, have resize tool around it
// when dragging, also drag the resize tool
// lock vertical position of resize tool when not dragging rock

// resize interaction:
// 		there is a rectangle with a thin border around the rock
// 		on the right side of that rectangle, there is a small rectangle
// 		this rectangle can be dragged left or right
// 		when the rectangle is dragged, the thin line through it will move too.
// 		when the rectangle is dragged, the available widths will be displayed with thin lines
// 		if an available width is reached, the rock will change to that width
// 		if an available width is not reached, the resize rect will snap back to place

var collection = new RockCollection();
collection.extendCollection(rockSetupData);
collection.extendCollection(exampleRockSetupData.data[currentExample]);
collection.extendCollection(benchRockData);

var selectedRock = null;
var resizeBox = {};

var correct = false;

function setCorrect() {
	correct = true;
}

function setIncorrect() {
	correct = false;
}

var setupBoard = function() {
	var svg = d3.select('body').append('svg')
		.attr('id', 'board')
		.attr('width', boardWidth)
		.attr('height', boardHeight)
		.classed('noselect', true);
		//.style({ display:'block', margin:'auto', padding:'0' });

	svg.append('rect')
	   .style('fill', boardColor)
	   .attr({width: '100%', height: '100%', 'stroke-width':'3', stroke:'rgb(0, 0, 0)'})
	   .classed('noselect', true);
}

var setupButtonZone = function() {
	var svg = d3.select('#board').append('svg')
		 .attr('id', 'buttonZone')
	   .style('fill', boardColor)
	   .attr({width: buttonZoneWidth, height: buttonZoneHeight})
	   .attr({x: buttonZoneX, y: buttonZoneY});

	svg.append('rect')
	   .style('fill', boardColor)
	   .attr({width: '100%', height: '100%', 'stroke-width':'3', stroke:'rgb(0, 0, 0)'})
}

var setupControlRockZone = function() {
	d3.select('#board').append('rect')
		 .attr('id', 'controlZone')
	   .style('fill', rockZoneColor)
	   .attr({width: rockZoneWidth, height: rockZoneHeight, 'stroke-width': '6', stroke: correctColor})
	   .attr({x: controlRockZoneX, y: controlRockZoneY})
	   .classed('noselect', true);
}

var setupUserRockZone = function() {
	d3.select('#board').append('rect')
		 .attr('id', 'userZone')
	   .style('fill', rockZoneColor)
	   .attr({width: rockZoneWidth, height: rockZoneHeight, 'stroke-width': '6', stroke: incorrectColor})
	   .attr({x: userRockZoneX, y: userRockZoneY})
	   .classed('noselect', true);
}

setupBoard();
setupButtonZone();
setupControlRockZone();
setupUserRockZone();

var setupNextButton = function() {
	var board = d3.select('#board');
	var button = board.append('g')
				.attr('id', 'nextButton');
  button.append('rect')
		.attr('id', 'nextButtonRect')
		.style({fill: buttonPushedColor})
		.attr('width', buttonWidth)
		.attr('height', buttonHeight)
		.attr({x: nextButtonX, y: nextButtonY});
	button.append('text')
		.style({fill: 'black', stroke: 'none', 'font-family': 'sans-serif', 'font-style': 'italic', 'font-size': 12})
		.attr({x: nextButtonX+10, y: nextButtonY+15})
		//.text('Next');
}

var setupGameControlButtons = function() {
	setupRefreshButton();
	setupNextButton();
}

setupNextButton();

var clickNext = function() {
	if (correct && currentExample<exampleRockSetupData.data.length-1) {
		removeResizeTool();
		collection.clearCollection();
		currentExample++;
		collection.extendCollection(rockSetupData);
		collection.extendCollection(exampleRockSetupData.data[currentExample]);
		collection.extendCollection(benchRockData);
		setupRocks();
		setupRockDblClickListeners();
		displayUserFeedback();
		setIncorrect();
	}
}

var setupNextButtonListener = function() {
	var button = d3.select('#nextButton');
	button.on('click', clickNext);
}

setupNextButtonListener();

var dragThreshold = 1;
var initialX = null, initialY = null;

function dragstart(d) {
	var rock_sel = d3.select(this);
	var rock = collection.getRockBySVG(rock_sel[0]);
	rock.x = d.x, rock.y = d.y;

	if (!initialX) {
		initialX = d3.event.x, initialY = d3.event.y;
		// console.log(initialX, initialY);
	}
  selectedRock = {rock: rock, rock_sel: rock_sel};
  appendResizeTool();
  resizeBox.handle.remove();
}

function dragmove(d) {
	d3.select(this)
    .attr("x", d.x = d3.event.x)
    .attr("y", d.y = d3.event.y);

  if (resizeBox.box) {
  	resizeBox.box
  		.attr("x", d.x)
  		.attr("y", d.y);
  }
}

function dragend(d) {
	selectedRock.rock.x = d.x, selectedRock.rock.y = d.y;
	//console.log(rock.x, rock.y);
	displayUserFeedback();
	initialX = null, initialY = null;
	clearPreviewLines()
	appendResizeTool();
}

var setupD3Drag = function() {
	var rockDrag = d3.behavior.drag()
	    .origin(function(d) { return d; })
	    .on('dragstart', dragstart)
	    .on('drag', dragmove)
	    .on('dragend', dragend);
	return rockDrag;
}

var board = d3.select('#board');
var resizeInitialX;

function resizeDragmove(d) {
	if (!resizeInitialX) {
		resizeInitialX = d3.event.x;
	}
	var circle_sel = d3.select(this)
		.attr('cx', d.x = d3.event.x);
	resizeBox.box
		.attr('width', d3.event.x - selectedRock.rock.x);
	if (!resizeBox.line1) {
		appendPreviewLines();
	}
	var newSize;
	// if the x value of this is about equal to a x+width value of another rock size
	if (newSize = resizeBoxInRangeOfOtherSize(circle_sel)) {
	//   set the rock type to be that other size, call update size
		selectedRock.rock.type = newSize.type;
		selectedRock.rock.updateSize();
	//   use d3 to change the size of the element
		selectedRock.rock_sel
			.attr('width', selectedRock.rock.width)
			.attr('height', selectedRock.rock.height);
		displayUserFeedback()
		clearPreviewLines();
	//   update the other sizes in resize box
		resizeBox.otherSizes = getOtherSizes(selectedRock.rock.type);
		appendPreviewLines();
	}
	// else
	//   do nothing
}

function appendPreviewLines() {
	var line1 = board.append('line')
		.attr({x1: selectedRock.rock.x+resizeBox.otherSizes[0].width, y1: selectedRock.rock.y
		      ,x2: selectedRock.rock.x+resizeBox.otherSizes[0].width, y2: selectedRock.rock.y+selectedRock.rock.height})
		.attr({'stroke-width': 1, 'stroke': 'black', opacity: 0.5});
	var line2 = board.append('line')
		.attr({x1: selectedRock.rock.x+resizeBox.otherSizes[1].width, y1: selectedRock.rock.y
		      ,x2: selectedRock.rock.x+resizeBox.otherSizes[1].width, y2: selectedRock.rock.y+selectedRock.rock.height})
		.attr({'stroke-width': 1, 'stroke': 'black', opacity: 0.5});
	resizeBox.line1 = line1;
	resizeBox.line2 = line2;
}

function clearPreviewLines() {
	if (resizeBox.line1) {
		resizeBox.line1.remove();
		delete resizeBox.line1;
	}
	if (resizeBox.line2) {
		resizeBox.line2.remove();
		delete resizeBox.line2;
	}
}

function resizeBoxInRangeOfOtherSize(circle_sel) {
	var x = circle_sel.data()[0].x;
	var halfBorderThickness = 3;
	for (var i=0; i<resizeBox.otherSizes.length; i++) {
		if (aboutEqual(x, selectedRock.rock.x+resizeBox.otherSizes[i].width, 3))
			return resizeBox.otherSizes[i];
	}
	return false
}

function resizeDragend(d) {
	// draw the resize tool to be the same size as the selected rock
	d3.select('#resizeBox').attr({x: selectedRock.rock.x, y: selectedRock.rock.y
		      						         ,width: selectedRock.rock.width, height: selectedRock.rock.height});
	d3.select('#resizeCircle').attr({cx: selectedRock.rock.x+selectedRock.rock.width
		      ,cy: (selectedRock.rock.y
		      		  + selectedRock.rock.y+selectedRock.rock.height)/2
		      ,r: resizeCircleRadius})
	clearPreviewLines();
	// set d x and y to be the size of selected rock
	d.x = selectedRock.rock.x+selectedRock.rock.width
}

var setupResizeDrag = function() {
	var resizeDrag = d3.behavior.drag()
		.origin(function(d) { return d; })
		.on('drag', resizeDragmove)
		.on('dragend', resizeDragend);
	return resizeDrag;
}

var setupRocks = function() {
	var rocks = d3.select('#board').selectAll('.rock')
    .data(collection.getCollectionData())
  .enter().append("rect")
  	.attr('class', 'rock')
  	.attr('id', function(d) {return d.id;})
    .attr("width", function(d) {return d.w;})
    .attr("height", function(d) {return d.h;})
    .attr('x', function(d) {return d.x;})
    .attr('y', function(d) {return d.y;})
    .style('fill', function(d) {return rockColors[d.color]})
    .attr({'stroke-width': 3, 'stroke': 'black', 'opacity': 0.5})
    .call(rockDrag);

  syncSVGsToCollection(rocks);

  return rocks;
}

var syncSVGsToCollection = function(sel) {
	var rocks = collection.getRocks();
	var svgs = sel[0]
	svgs = svgs.filter(function(svg) {return svg});
	for (var i=rocks.length-svgs.length; i<rocks.length; i++) {
		rocks[i].setSVG(svgs[i-(rocks.length-svgs.length)]);
	}
}

var getRockByID = function(el) {
	var searchID = el.getAttribute('id');
	var r;
	var rocks = collection.getRocks();
	for (var i=0; i<rocks.length; i++) {
		r = rocks[i];
		if (searchID === r.getID()) return r;
	}
	return null;
}

var changeRockColor = function(rock) {
	var svg = rock.getSVG();
	rock_sel = d3.select(svg);
	rock.color = (rock.color+1)%3;
	rock_sel.style('fill', rockColors[rock.color]);
	displayUserFeedback();
	selectedRock = {rock: rock, rock_sel: rock_sel};
	appendResizeTool();
}

var changeRockShape = function(rock) {
	rock.rotateSize();
	var svg = rock.getSVG();
	svg.setAttribute('width', rock.width);
	svg.setAttribute('height', rock.height);
	displayUserFeedback();
}

var dblClickRock = function() {
	var rock = getRockByID(this);
	changeRockColor(rock);
}

var setupRockDblClickListeners = function() {
	var rocks = collection.getRocks();
	for (var i=0; i<rocks.length; i++) {
		var rockSel = d3.select('#' + rocks[i].getID());
		rockSel.on('dblclick', dblClickRock);
	}
}

var activateNextButton = function() {
	d3.select('#nextButtonRect').style({fill: buttonColor});
}

var deactivateNextButton = function() {
	d3.select('#nextButtonRect').style("fill", buttonPushedColor);
}

var displayUserFeedback = function() {
	checkControlWindow();
	checkUserWindow();
}

function checkControlWindow() {
	if (controlWindowSatisfiesSupportCategory()) {
		showCorrect('#controlZone');
	} else {
		showIncorrect('#controlZone');
	}
}

function checkUserWindow() {
	if (userWindowSatisfiesSupportCategory()) {
		showCorrect('#userZone');
		setCorrect();
		activateNextButton();
	} else {
		showIncorrect('#userZone');
		setIncorrect();
		deactivateNextButton();
	}
}

var showCorrect = function(zoneID) {
	d3.select(zoneID)
	  .attr('stroke', correctColor);
}

var showIncorrect = function(zoneID) {
	d3.select(zoneID)
	  .attr('stroke', incorrectColor);
}

rockDrag = setupD3Drag();
setupRocks();
setupRockDblClickListeners();

function appendResizeTool() {
	if (selectedRock) {
		removeResizeTool();
		resizeBox.otherSizes = getOtherSizes(selectedRock.rock.type);
		resizeBox.box = appendResizeBox();
		resizeBox.handle = appendResizeCircle()
	}
}

function appendResizeBox() {
	var box = d3.select('#board').append('rect')
		.attr('id', 'resizeBox')
		.attr({x: selectedRock.rock.x, y: selectedRock.rock.y
		      ,width: selectedRock.rock.width, height: selectedRock.rock.height})
		.attr({'stroke-width': 1, 'stroke': 'black'})
		.style({fill: 'none'});
	return box;
}

function appendResizeCircle() {
	var handle = d3.select('#board').selectAll('.handle')
		.data([{x: selectedRock.rock.x+selectedRock.rock.width
		       ,y: (selectedRock.rock.y
		      		  + selectedRock.rock.y+selectedRock.rock.height)/2}])
		.enter().append('circle')
		.attr('class', 'handle')
	 	.attr('id', 'resizeCircle')
	 	.attr('cx', function(d){return d.x})
	 	.attr('cy', function(d){return d.y})
	 	.attr('r', resizeCircleRadius)
		.attr({'stroke':'black', 'stroke-width':1})
		.style({fill: 'blue'})
		.call(resizeToolDrag);
	return handle;
}

function removeResizeTool() {
	d3.select('#resizeBox').remove();
	d3.select('#resizeCircle').remove();
}

resizeToolDrag = setupResizeDrag();

function getOtherSizes(size) {
	var small = getSizeDimensions('small')
	   ,medium = getSizeDimensions('medium')
	   ,large = getSizeDimensions('large');
	switch (size) {
		case 'small':
			return [medium, large];
		case 'medium':
			return [small, large];
		case 'large':
			return [small, medium];
	}
}

function getSizeDimensions(size) {
	switch (size) {
		case 'small':
			return {type: 'small', width: smallRockWidth, height: smallRockHeight};
		case 'medium':
			return {type: 'medium', width: mediumRockWidth, height: mediumRockHeight};
		case 'large':
			return {type: 'large', width: largeRockWidth, height: largeRockHeight};
	}
}

</script>