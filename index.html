<!doctype html>

<title>Meta-analogies (rocks)</title>
<script src='d3.min.js'></script>
<script src='settings.js'></script>
<script src='rock.js'></script>
<script src='support-category.js'></script>
<script src='data.js'></script>

<body>
</body>

<script>

var collection = new RockCollection();
collection.extendCollection(rockSetupData);
collection.extendCollection(exampleRockSetupData.data[currentExample]);
collection.extendCollection(benchRockData);

var correct = false;

function setCorrect() {
	correct = true;
}

function setIncorrect() {
	correct = false;
}

var setupBoard = function() {
	var svg = d3.select('body').append('svg')
		.attr('id', 'board')
		.attr('width', boardWidth)
		.attr('height', boardHeight);
		//.style({ display:'block', margin:'auto', padding:'0' });

	svg.append('rect')
	   .style('fill', boardColor)
	   .attr({width: '100%', height: '100%', 'stroke-width':'3', stroke:'rgb(0, 0, 0)'});
}

var setupButtonZone = function() {
	var svg = d3.select('#board').append('svg')
		 .attr('id', 'buttonZone')
	   .style('fill', boardColor)
	   .attr({width: buttonZoneWidth, height: buttonZoneHeight})
	   .attr({x: buttonZoneX, y: buttonZoneY});

	svg.append('rect')
	   .style('fill', boardColor)
	   .attr({width: '100%', height: '100%', 'stroke-width':'3', stroke:'rgb(0, 0, 0)'})
}

var setupControlRockZone = function() {
	d3.select('#board').append('rect')
		 .attr('id', 'controlZone')
	   .style('fill', rockZoneColor)
	   .attr({width: rockZoneWidth, height: rockZoneHeight, 'stroke-width': '6', stroke: correctColor})
	   .attr({x: controlRockZoneX, y: controlRockZoneY});
}

var setupUserRockZone = function() {
	d3.select('#board').append('rect')
		 .attr('id', 'userZone')
	   .style('fill', rockZoneColor)
	   .attr({width: rockZoneWidth, height: rockZoneHeight, 'stroke-width': '6', stroke: incorrectColor})
	   .attr({x: userRockZoneX, y: userRockZoneY});
}

setupBoard();
setupButtonZone();
setupControlRockZone();
setupUserRockZone();

var setupColorButton = function() {
	var buttonZone = d3.select('#buttonZone');
	var button = buttonZone.append('g')
				.attr('id', 'colorButton');
  button.append('rect')
		.attr('id', 'colorButtonRect')
		.style({fill: buttonPushedColor})
		.attr('width', buttonWidth)
		.attr('height', buttonHeight)
		.attr({x: colorButtonX, y: colorButtonY});
	button.append('text')
		.style({fill: 'black', stroke: 'none', 'font-family': 'sans-serif', 'font-style': 'italic', 'font-size': 12})
		.attr({x: colorButtonX+10, y: colorButtonY+15})
		.text('Color');
}

var setupShapeButton = function() {
	var buttonZone = d3.select('#buttonZone');
	var button = buttonZone.append('g')
				.attr('id', 'shapeButton');
  button.append('rect')
		.attr('id', 'shapeButtonRect')
		.style({fill: buttonColor})
		.attr('width', buttonWidth)
		.attr('height', buttonHeight)
		.attr({x: shapeButtonX, y: shapeButtonY});
	button.append('text')
		.style({fill: 'black', stroke: 'none', 'font-family': 'sans-serif', 'font-style': 'italic', 'font-size': 12})
		.attr({x: shapeButtonX+10, y: shapeButtonY+15})
		.text('Shape');
}

var setupRockManipulationButtons = function() {
	setupColorButton();
	setupShapeButton();
}

var setupRefreshButton = function() {

}

var setupNextButton = function() {
	var board = d3.select('#board');
	var button = board.append('g')
				.attr('id', 'nextButton');
  button.append('rect')
		.attr('id', 'nextButtonRect')
		.style({fill: buttonPushedColor})
		.attr('width', buttonWidth)
		.attr('height', buttonHeight)
		.attr({x: nextButtonX, y: nextButtonY});
	button.append('text')
		.style({fill: 'black', stroke: 'none', 'font-family': 'sans-serif', 'font-style': 'italic', 'font-size': 12})
		.attr({x: nextButtonX+10, y: nextButtonY+15})
		.text('Next');
}

var setupGameControlButtons = function() {
	setupRefreshButton();
	setupNextButton();
}

setupRockManipulationButtons();
setupNextButton();

var clickColor = function() {
	d3.select('#shapeButtonRect').style({fill: buttonColor});
	d3.select('#positionButtonRect').style({fill: buttonColor});
	var button = d3.select('#colorButtonRect');
	button.style({fill: buttonPushedColor});
	currentControlMode = 'color';
	prevMode = 'color';
	console.log(currentControlMode);
}

var clickShape = function() {
	d3.select('#colorButtonRect').style({fill: buttonColor});
	d3.select('#positionButtonRect').style({fill: buttonColor});
	var button = d3.select('#shapeButtonRect');
	button.style({fill: buttonPushedColor});
	currentControlMode = 'shape';
	prevMode = 'shape';
	console.log(currentControlMode);
}

var setupColorButtonListener = function() {
	var button = d3.select('#colorButton');
	button.on('click', clickColor);
}

var setupShapeButtonListener = function() {
	var button = d3.select('#shapeButton');
	button.on('click', clickShape);
}

var setupRockManipulationButtonListeners = function() {
	setupColorButtonListener();
	setupShapeButtonListener();
}

setupRockManipulationButtonListeners();

var clickNext = function() {
	if (correct && currentExample<exampleRockSetupData.data.length-1) {
		collection.clearCollection();
		currentExample++;
		collection.extendCollection(rockSetupData);
		collection.extendCollection(exampleRockSetupData.data[currentExample]);
		collection.extendCollection(benchRockData);
		setupRocks();
		setupRockClickListeners();
		displayUserFeedback();
		setIncorrect();
	}
}

var setupNextButtonListener = function() {
	var button = d3.select('#nextButton');
	button.on('click', clickNext);
}

setupNextButtonListener();

var prevMode = 'color';
var dragThreshold = 1;
var initialX = null, initialY = null;

function dragmove(d) {
	currentControlMode = prevMode;
	if (!initialX) {
		initialX = d3.event.x, initialY = d3.event.y;
		// console.log(initialX, initialY);
	}
  d3.select(this)
      .attr("x", d.x = d3.event.x)
      .attr("y", d.y = d3.event.y);
}

function dragend(d) {
	var rockSVG = d3.select(this);
	var rock = collection.getRockBySVG(rockSVG[0]);
	rock.x = d.x, rock.y = d.y;
	//console.log(rock.x, rock.y);
	displayUserFeedback();
	if (initialX && (Math.abs(rock.x-initialX)>dragThreshold || Math.abs(rock.y-initialY)>dragThreshold)) {
		prevMode = currentControlMode;
		currentControlMode = 'position';
		initialX = null, initialY = null;
	} else {
		currentControlMode = prevMode;
		initialX = null, initialY = null;
	}
}

var setupD3Drag = function() {
	var rockDrag = d3.behavior.drag()
	    .origin(function(d) { return d; })
	    .on('drag', dragmove)
	    .on('dragend', dragend);
	return rockDrag;
}

var setupRocks = function() {
	var rocks = d3.select('#board').selectAll('.rock')
    .data(collection.getCollectionData())
  .enter().append("rect")
  	.attr('class', 'rock')
  	.attr('id', function(d) {return d.id;})
    .attr("width", function(d) {return d.w;})
    .attr("height", function(d) {return d.h;})
    .attr('x', function(d) {return d.x;})
    .attr('y', function(d) {return d.y;})
    .style('fill', function(d) {return rockColors[d.color]})
    .attr({'stroke-width': 3, 'stroke': 'black', 'opacity': 0.5})
    .call(rockDrag);

  syncSVGsToCollection(rocks);

  return rocks;
}

var syncSVGsToCollection = function(sel) {
	var rocks = collection.getRocks();
	var svgs = sel[0]
	svgs = svgs.filter(function(svg) {return svg});
	for (var i=rocks.length-svgs.length; i<rocks.length; i++) {
		rocks[i].setSVG(svgs[i-(rocks.length-svgs.length)]);
	}
}

var getRockByID = function(el) {
	var searchID = el.getAttribute('id');
	var r;
	var rocks = collection.getRocks();
	for (var i=0; i<rocks.length; i++) {
		r = rocks[i];
		if (searchID === r.getID()) return r;
	}
	return null;
}

var changeRockColor = function(rock) {
	if (currentControlMode==='color') {
		var svg = rock.getSVG();
		sel_rock = d3.select(svg);
		rock.color = (rock.color+1)%3;
		sel_rock.style('fill', rockColors[rock.color]);
		displayUserFeedback();
	}
}

var changeRockShape = function(rock) {
	if (currentControlMode==='shape') {
		rock.rotateSize();
		var svg = rock.getSVG();
		svg.setAttribute('width', rock.width);
		svg.setAttribute('height', rock.height);
		displayUserFeedback();
	}
}

var clickRock = function() {
	if (currentControlMode==='shape' || currentControlMode==='color') {
		var rock = getRockByID(this);
		changeRockColor(rock);
		changeRockShape(rock);
	}
}

var setupRockClickListeners = function() {
	var rocks = collection.getRocks();
	for (var i=0; i<rocks.length; i++) {
		var rockSel = d3.select('#' + rocks[i].getID());
		rockSel.on('click', clickRock);
	}
}

var activateNextButton = function() {
	d3.select('#nextButtonRect').style({fill: buttonColor});
}

var deactivateNextButton = function() {
	d3.select('#nextButtonRect').style("fill", buttonPushedColor);
}

var displayUserFeedback = function() {
	checkControlWindow();
	checkUserWindow();
}

function checkControlWindow() {
	if (controlWindowSatisfiesSupportCategory()) {
		showCorrect('#controlZone');
	} else {
		showIncorrect('#controlZone');
	}
}

function checkUserWindow() {
	if (userWindowSatisfiesSupportCategory()) {
		showCorrect('#userZone');
		setCorrect();
		activateNextButton();
	} else {
		showIncorrect('#userZone');
		setIncorrect();
		deactivateNextButton();
	}
}

var showCorrect = function(zoneID) {
	d3.select(zoneID)
	  .attr('stroke', correctColor);
}

var showIncorrect = function(zoneID) {
	d3.select(zoneID)
	  .attr('stroke', incorrectColor);
}

var rockDrag = setupD3Drag();
setupRocks();
setupRockClickListeners();

</script>